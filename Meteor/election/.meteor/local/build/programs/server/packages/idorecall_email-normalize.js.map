{"version":3,"sources":["meteor://ðŸ’»app/packages/idorecall_email-normalize/packages/idorecall_email-normalize.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2E","file":"/packages/idorecall_email-normalize.js","sourcesContent":["(function () {\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                   //\n// packages/idorecall:email-normalize/email.js                                                                       //\n//                                                                                                                   //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                     //\n'use strict';                                                                                                        // 1\n                                                                                                                     // 2\n// TODO extract out Node.js module. See http://stackoverflow.com/questions/6048504/synchronous-request-in-nodejs     // 3\n                                                                                                                     // 4\nEmail = this.Email || {};                                                                                            // 5\n                                                                                                                     // 6\nEmail.domainsWithTags = {                                                                                            // 7\n  // Google only has two Gmail domains: https://en.wikipedia.org/wiki/List_of_Google_domains                         // 8\n  'gmail.com': '+',                                                                                                  // 9\n  'googlemail.com': '+',                                                                                             // 10\n  'google.com': '+',  // corporate email addresses; TODO presumably country domains also receive corporate email?    // 11\n  // Microsoft                                                                                                       // 12\n  'outlook.com': '+',                                                                                                // 13\n  'hotmail.com': '+',                                                                                                // 14\n  'live.com': '+',                                                                                                   // 15\n  // Fastmail - https://www.fastmail.com/help/receive/addressing.html TODO: whatever@username.fastmail.com -> username@fastmail.com\n  'fastmail.com': '+',                                                                                               // 17\n  'fastmail.fm': '+',                                                                                                // 18\n  // Yahoo Mail Plus accounts, per https://en.wikipedia.org/wiki/Yahoo!_Mail#Email_domains, use hyphens - http://www.cnet.com/forums/discussions/did-yahoo-break-disposable-email-addresses-mail-plus-395088/\n  'yahoo.com.ar' : '-',                                                                                              // 20\n  'yahoo.com.au' : '-',                                                                                              // 21\n  'yahoo.at' : '-',                                                                                                  // 22\n  'yahoo.be/fr' : '-',                                                                                               // 23\n  'yahoo.be/nl' : '-',                                                                                               // 24\n  'yahoo.com.br' : '-',                                                                                              // 25\n  'ca.yahoo.com' : '-',                                                                                              // 26\n  'qc.yahoo.com' : '-',                                                                                              // 27\n  'yahoo.com.co' : '-',                                                                                              // 28\n  'yahoo.com.hr' : '-',                                                                                              // 29\n  'yahoo.cz' : '-',                                                                                                  // 30\n  'yahoo.dk' : '-',                                                                                                  // 31\n  'yahoo.fi' : '-',                                                                                                  // 32\n  'yahoo.fr' : '-',                                                                                                  // 33\n  'yahoo.de' : '-',                                                                                                  // 34\n  'yahoo.gr' : '-',                                                                                                  // 35\n  'yahoo.com.hk' : '-',                                                                                              // 36\n  'yahoo.hu' : '-',                                                                                                  // 37\n  'yahoo.co.in/yahoo.in' : '-',                                                                                      // 38\n  'yahoo.co.id' : '-',                                                                                               // 39\n  'yahoo.ie' : '-',                                                                                                  // 40\n  'yahoo.co.il' : '-',                                                                                               // 41\n  'yahoo.it' : '-',                                                                                                  // 42\n  'yahoo.co.jp' : '-',                                                                                               // 43\n  'yahoo.com.my' : '-',                                                                                              // 44\n  'yahoo.com.mx' : '-',                                                                                              // 45\n  'yahoo.ae' : '-',                                                                                                  // 46\n  'yahoo.nl' : '-',                                                                                                  // 47\n  'yahoo.co.nz' : '-',                                                                                               // 48\n  'yahoo.no' : '-',                                                                                                  // 49\n  'yahoo.com.ph' : '-',                                                                                              // 50\n  'yahoo.pl' : '-',                                                                                                  // 51\n  'yahoo.pt' : '-',                                                                                                  // 52\n  'yahoo.ro' : '-',                                                                                                  // 53\n  'yahoo.ru' : '-',                                                                                                  // 54\n  'yahoo.com.sg' : '-',                                                                                              // 55\n  'yahoo.co.za' : '-',                                                                                               // 56\n  'yahoo.es' : '-',                                                                                                  // 57\n  'yahoo.se' : '-',                                                                                                  // 58\n  'yahoo.ch/fr' : '-',                                                                                               // 59\n  'yahoo.ch/de' : '-',                                                                                               // 60\n  'yahoo.com.tw' : '-',                                                                                              // 61\n  'yahoo.co.th' : '-',                                                                                               // 62\n  'yahoo.com.tr' : '-',                                                                                              // 63\n  'yahoo.co.uk' : '-',                                                                                               // 64\n  'yahoo.com' : '-',                                                                                                 // 65\n  'yahoo.com.vn' : '-'                                                                                               // 66\n};                                                                                                                   // 67\n                                                                                                                     // 68\n                                                                                                                     // 69\n/**                                                                                                                  // 70\n * Normalize an email address by removing the dots and address tag.                                                  // 71\n * @param {string} email                                                                                             // 72\n * @param {object} [options]                                                                                         // 73\n * @param {boolean} options.forceRemoveDots                                                                          // 74\n * @param {boolean} options.forceRemoveTags                                                                          // 75\n * @param {boolean} options.detectProvider - Make a DNS call to detect if the email host provider is one that might  // 76\n *        provide email address tags, such as Google Apps for Work. Requires callback on the client.                 // 77\n * @param {function} [callback] - On the client and only if `detectProvider` is true: callback that will be passed   // 78\n *        `error` and `result`. This is required because we make an async HTTP request to DNS resolve the domain.    // 79\n * @returns {string}                                                                                                 // 80\n */                                                                                                                  // 81\nEmail.normalize = function normalizeEmail(email, options, callback) {                                                // 82\n  // TODO destructure when ES6 lands                                                                                 // 83\n  options = options || {};                                                                                           // 84\n  options.forceRemoveDots = options.forceRemoveDots || false;                                                        // 85\n  options.forceRemoveTags = options.forceRemoveTags || false;                                                        // 86\n  options.detectProvider = options.detectProvider || false;                                                          // 87\n                                                                                                                     // 88\n  email = email.trim().toLowerCase();                                                                                // 89\n                                                                                                                     // 90\n  var emailParts = email.split(/@/);                                                                                 // 91\n  var user = emailParts[0];                                                                                          // 92\n  var domain = emailParts[1];                                                                                        // 93\n                                                                                                                     // 94\n  if (options.forceRemoveTags) {                                                                                     // 95\n    user = user.replace(/[-+=].*/, '');                                                                              // 96\n  } else {                                                                                                           // 97\n    var separator = Email.domainsWithTags[domain];                                                                   // 98\n    if (separator) user = user.split(separator)[0];                                                                  // 99\n  }                                                                                                                  // 100\n                                                                                                                     // 101\n  if (options.forceRemoveDots || /^(gmail|googlemail|google)\\.com$/.test(domain)) {                                  // 102\n    user = user.replace(/\\./g, '');                                                                                  // 103\n  }                                                                                                                  // 104\n                                                                                                                     // 105\n  if (domain === 'googlemail.com') {                                                                                 // 106\n    domain = 'gmail.com';                                                                                            // 107\n  }                                                                                                                  // 108\n                                                                                                                     // 109\n  if (options.detectProvider) {                                                                                      // 110\n    // detect custom domain email hosting providers TODO providers from https://news.ycombinator.com/item?id=8533588 // 111\n                                                                                                                     // 112\n    var processMXRecords = function processMXRecords(address, user) {                                                // 113\n      // presumably, if at least one MX points to a service provider, then the user should expect the provider's special handling when it comes to dots or address tags\n      if (/aspmx.*google.*\\.com\\.?$/i.test(address)) {                                                               // 115\n        return user.split('+')[0].replace(/\\./g, '');  // Google Apps for Work                                       // 116\n      }                                                                                                              // 117\n      // FastMail - https://www.fastmail.com/help/receive/domains.html                                               // 118\n      if (/\\.messagingengine\\.com\\.?$/i.test(address)) {                                                             // 119\n        return user.split('+')[0];  // dots are significant - https://www.fastmail.com/help/account/changeusername.html\n      }                                                                                                              // 121\n      return user;                                                                                                   // 122\n    };                                                                                                               // 123\n                                                                                                                     // 124\n    if (Meteor.isClient) {                                                                                           // 125\n      if (typeof callback !== 'function')                                                                            // 126\n        throw new Error('Detecting the provider from the client requires a callback.');                              // 127\n                                                                                                                     // 128\n      return HTTP.get('http://enclout.com/api/v1/dns/show.json', {params: {url: domain}}, function (error, result) { // 129\n        if (error) return callback(error);                                                                           // 130\n        var addresses = result.data.dns_entries;                                                                     // 131\n        for (var i = 0; i < addresses.length; i++) {                                                                 // 132\n          if (!addresses[i].Type) return callback('Could not find Type field in Enclout API result. Has the format changed?');\n          if (addresses[i].Type === 'MX') user = processMXRecords(addresses[i].RData, user);                         // 134\n        }                                                                                                            // 135\n        // Either nothing matched, or some MX record did, and `user` was changed. Yes, multiple records could in theory match, but how would anyone decide in that case how to treat the user part?\n        return callback(null, user + '@' + domain);                                                                  // 137\n      });                                                                                                            // 138\n    } else {                                                                                                         // 139\n      // On the server, we can use directly https://nodejs.org/api/dns.html#dns_dns_resolvemx_hostname_callback      // 140\n      var resolveMx = Meteor.wrapAsync(Npm.require('dns').resolveMx);                                                // 141\n      if (typeof callback === 'function') {                                                                          // 142\n        resolveMx(domain, function (error, addresses) {                                                              // 143\n          if (error) return callback(error);                                                                         // 144\n                                                                                                                     // 145\n          for (var i = 0; i < addresses.length; i++) {                                                               // 146\n            user = processMXRecords(addresses[i].exchange, user);                                                    // 147\n          }                                                                                                          // 148\n          // nothing matched                                                                                         // 149\n          return callback(null, user + '@' + domain);                                                                // 150\n        });                                                                                                          // 151\n      } else {                                                                                                       // 152\n        // synchronous server code                                                                                   // 153\n        var addresses = resolveMx(domain);                                                                           // 154\n        for (var i = 0; i < addresses.length; i++ ) {                                                                // 155\n          user = processMXRecords(addresses[i].exchange, user);                                                      // 156\n        }                                                                                                            // 157\n        return user + '@' + domain;                                                                                  // 158\n      }                                                                                                              // 159\n    }                                                                                                                // 160\n  }                                                                                                                  // 161\n                                                                                                                     // 162\n  return user + '@' + domain;                                                                                        // 163\n};                                                                                                                   // 164\n                                                                                                                     // 165\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n"]}